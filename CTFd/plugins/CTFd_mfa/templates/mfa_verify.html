{% extends "base.html" %}

{% block content %}
<div class="jumbotron">
  <div class="container">
    <h1>{% trans %}Two-Factor Authentication{% endtrans %}</h1>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-6 offset-md-3">
      <div class="card">
        <div class="card-header">
          <h4>{% trans %}Enter Authentication Code{% endtrans %}</h4>
        </div>
        <div class="card-body">
          <p>{% trans %}Enter the 6-digit code from your authenticator app{% endtrans %}</p>
          
          <form id="mfa-verify-form">
          <input type="hidden" name="nonce" value="{{ nonce }}">
              <input type="text" id="code" name="code" class="form-control form-control-lg text-center" maxlength="6" pattern="[0-9]{6}" required autofocus placeholder="000000" style="font-size: 2em; letter-spacing: 0.5em;">
            </div>
            <button type="submit" class="btn btn-primary w-100">{% trans %}Verify{% endtrans %}</button>
          </form>
          
          <div id="result-message" class="mt-3"></div>
          
          <div class="mt-3 text-center">
            <a href="{{ url_for('auth.login') }}" class="text-muted">{% trans %}Back to login{% endtrans %}</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('mfa-verify-form');
  const codeInput = document.getElementById('code');
  const resultDiv = document.getElementById('result-message');
  
  // Auto-submit when 6 digits are entered
  codeInput.addEventListener('input', function() {
    if (this.value.length === 6) {
      form.dispatchEvent(new Event('submit'));
    }
  });
  
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const code = codeInput.value;
    const nonce = document.querySelector('input[name="nonce"]').value;
    
    try {
      const response = await fetch('/mfa/verify-login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({ code: code, nonce: nonce })
      });
      
      const data = await response.json();
      
      if (data.success) {
        resultDiv.innerHTML = '<div class="alert alert-success">Authentication successful! Redirecting...</div>';
        setTimeout(() => window.location.href = data.redirect, 1000);
      } else {
        resultDiv.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
        codeInput.value = '';
        codeInput.focus();
      }
    } catch (error) {
      resultDiv.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
      codeInput.value = '';
      codeInput.focus();
    }
  });
});
</script>
{% endblock %}
